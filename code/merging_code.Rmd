---
title: "merging_code"
author: "Leonardo Feitosa"
date: "27/07/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(sf)
library(reshape2)
library(rnaturalearth)
```

```{r}
# Create file paths
# Set directories
basedir <- "G:/Meu Drive/fish_mgmt_areas/data"
indir <- file.path(basedir, "nefsc_stat_areas", "raw")
nefsc_dir <- file.path(basedir, "nefsc_stat_areas", "processed")
gulf_dir <- file.path(basedir, "gulf_of_mexico", "processed")
out_final <- file.path(basedir, "processed_files")
plotdir <- "figures"
```

```{r}

world <- ne_countries(scale = "medium", returnclass = "sf")
# read in the data

nefsc <- list.files(file.path(nefsc_dir),
                    pattern = "*.Rds",
                    full.names = TRUE)

nefsc_tbl <- sapply(nefsc, readRDS, simplify = FALSE) 

nefsc_tbl_2 <- nefsc_tbl %>% 
  bind_rows() %>% 
  mutate(species = str_to_lower(species)) %>% 
  separate_rows(country, sep = "/") %>% 
  mutate(iso_a3 = case_when(
    country == "USA" ~ "USA",
    country == "Canada" ~ "CAN"))

east <- st_read(file.path(out_final, "USA_southeast_coast.gpkg"))

king_mack <- readRDS(file.path(gulf_dir, "USA_king_mackerel_migratory_zones.Rds"))
lobster <- readRDS(file.path(gulf_dir, "USA_spiny_lobster_mgmt_areas.Rds")) %>% 
  mutate(zone_name = as.character(zone_name))
span_mack <- readRDS(file.path(gulf_dir, "USA_spanish_mackerel_migratory_zones.Rds"))
cobia <- readRDS(file.path(gulf_dir, "USA_cobia_migratory_zones.Rds"))

east_us <- bind_rows(king_mack,
                     lobster,
                     span_mack,
                     cobia)
```

```{r}
# wrangling and plotting
df_orig_geo <- df_orig %>% 
  st_drop_geometry()

stur_2_geo <- df_sturg %>% 
  st_drop_geometry()

nefsc_tbl_geo <- nefsc_tbl_2 %>%
  st_drop_geometry()

whale_geo <- df_whale %>% 
  st_drop_geometry()

df_orig_geo <- df_orig %>% 
  st_drop_geometry()

df_final_geo <- df_final %>% 
  st_drop_geometry()
```


```{r}
df_final <- east_us %>%  
  mutate(pk_system_history = NA,
         fk_system = NA,
         name_english = dataset,
         name_local = dataset,
         additional_descriptor = zone_name,
         code = NA,
         multispecies = NA,
         multispecies_comment = species,
         fk_system_type = NA,
         fk_system_category = type,
         fk_system_owner = "NOAA",
         fk_system_subowner = NA,
         source = citation,
         source_date = "2022-07-28",
         usage = NA,
         lineage = "Downloaded and imported from NOAA on 2022-07-28",
         comment = NA,
         created_by = "Leonardo Manir Feitosa",
         created_on = "2022-07-28",
         changed_by = NA,
         changed_on = NA,
         iso_a3 = "USA",
         area_name = zone_id) %>% 
  relocate(source, .before = source_date) %>% 
  mutate(multispecies = case_when(
    str_detect(multispecies_comment, "multi") ~ "1",
    TRUE ~ "0"
  )) %>% 
  select(-dataset, -country, -ocean, -region, -agency, -zone_id, -zone_name, -species, -type, -species_list)  
```

```{r}
# export shapefile
st_write(df_final, file.path(out_final, "USA_east.gpkg"))
```
 
```{r}
ggplot() +
#  geom_sf(data = world) +
  geom_sf(data = east_coast, aes(fill = name_english),
          show.legend = F) 
  coord_sf(xlim = c(-90, -50),
           ylim = c(20, 50))
```

```{r}
east_coast <- list.files(file.path(out_final),
                         pattern = "*.gpkg",
                         full.names = TRUE)

east_coast_tbl <- sapply(east_coast, st_read, simplify = FALSE)

east_coast_tbl_2 <- east_coast_tbl %>% 
  bind_rows() %>% 
  select(-source) %>% 
  rename(source = citation) %>% 
  relocate(source, .before = source_date)

ggplot() +
  geom_sf(data = east_coast_tbl_2, aes(fill = name_english),
          show.legend = F)

st_write(east_coast_tbl_2, file.path(out_final, "USA_east_final.gpkg"))
```























